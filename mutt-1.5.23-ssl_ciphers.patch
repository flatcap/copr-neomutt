From b9039dd2143cfb528a034391c4a3ddbc2ae970ba Mon Sep 17 00:00:00 2001
From: Richard Russon <rich@flatcap.org>
Date: Wed, 1 Jun 2016 21:38:22 +0100
Subject: [PATCH 3/5] mutt-1.5.23-ssl_ciphers

---
 conn/gnutls.c | 59 +++++++++++++++++++++++++++------------------------
 mutt_config.c |  2 +-
 2 files changed, 32 insertions(+), 29 deletions(-)

diff --git a/conn/gnutls.c b/conn/gnutls.c
index 3759630be5..3942670e5b 100644
--- a/conn/gnutls.c
+++ b/conn/gnutls.c
@@ -757,36 +757,39 @@ static int tls_set_priority(struct TlsSockData *data)
   else
     mutt_buffer_strcpy(priority, "NORMAL");
 
-  if (!C_SslUseTlsv13)
+  if (C_SslCiphers && (strcmp(C_SslCiphers, "@SYSTEM") == 0))
   {
-    nproto--;
-    mutt_buffer_addstr(priority, ":-VERS-TLS1.3");
-  }
-  if (!C_SslUseTlsv12)
-  {
-    nproto--;
-    mutt_buffer_addstr(priority, ":-VERS-TLS1.2");
-  }
-  if (!C_SslUseTlsv11)
-  {
-    nproto--;
-    mutt_buffer_addstr(priority, ":-VERS-TLS1.1");
-  }
-  if (!C_SslUseTlsv1)
-  {
-    nproto--;
-    mutt_buffer_addstr(priority, ":-VERS-TLS1.0");
-  }
-  if (!C_SslUseSslv3)
-  {
-    nproto--;
-    mutt_buffer_addstr(priority, ":-VERS-SSL3.0");
-  }
+    if (!C_SslUseTlsv13)
+    {
+      nproto--;
+      mutt_buffer_addstr(priority, ":-VERS-TLS1.3");
+    }
+    if (!C_SslUseTlsv12)
+    {
+      nproto--;
+      mutt_buffer_addstr(priority, ":-VERS-TLS1.2");
+    }
+    if (!C_SslUseTlsv11)
+    {
+      nproto--;
+      mutt_buffer_addstr(priority, ":-VERS-TLS1.1");
+    }
+    if (!C_SslUseTlsv1)
+    {
+      nproto--;
+      mutt_buffer_addstr(priority, ":-VERS-TLS1.0");
+    }
+    if (!C_SslUseSslv3)
+    {
+      nproto--;
+      mutt_buffer_addstr(priority, ":-VERS-SSL3.0");
+    }
 
-  if (nproto == 0)
-  {
-    mutt_error(_("All available protocols for TLS/SSL connection disabled"));
-    goto cleanup;
+    if (nproto == 0)
+    {
+      mutt_error(_("All available protocols for TLS/SSL connection disabled"));
+      goto cleanup;
+    }
   }
 
   int err = gnutls_priority_set_direct(data->state, mutt_b2s(priority), NULL);
diff --git a/mutt_config.c b/mutt_config.c
index 88005ddaf8..0648f12b8f 100644
--- a/mutt_config.c
+++ b/mutt_config.c
@@ -4381,7 +4381,7 @@ struct ConfigDef MuttVars[] = {
   ** .te
   */
 #endif /* USE_SSL_GNUTLS */
-  { "ssl_ciphers", DT_STRING, &C_SslCiphers, 0 },
+  { "ssl_ciphers", DT_STRING, &C_SslCiphers, IP "@SYSTEM" },
   /*
   ** .pp
   ** Contains a colon-separated list of ciphers to use when using SSL.
